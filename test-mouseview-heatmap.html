<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MouseView Heatmap Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #222;
            color: #fff;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #444;
            border-radius: 8px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
        }
        .status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
        }
        .status.info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196F3;
        }
        pre {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <h1>MouseView plotHeatMap() Investigation</h1>
    
    <div class="test-section">
        <h3>1. Generate Sample Mouse Data</h3>
        <button onclick="generateMouseData()">Generate Sample Data</button>
        <div id="data-status"></div>
    </div>

    <div class="test-section">
        <h3>2. Test MouseView plotHeatMap()</h3>
        <button onclick="testPlotHeatMap()">Plot Heatmap</button>
        <button onclick="clearHeatMap()">Clear Heatmap</button>
        <div id="heatmap-status"></div>
    </div>

    <div class="test-section">
        <h3>3. Check Canvas and Screenshot Capability</h3>
        <button onclick="inspectHeatmapCanvas()">Inspect Canvas</button>
        <button onclick="screenshotHeatmap()">Screenshot Heatmap</button>
        <div id="canvas-status"></div>
    </div>

    <div class="test-section">
        <h3>4. Canvas Investigation Results</h3>
        <div id="investigation-results"></div>
    </div>

    <!-- Include MouseView.js -->
    <script src="https://mouseview-docs.netlify.app/MouseView.js" type="module"></script>
    
    <script>
        let mouseData = [];
        
        function generateMouseData() {
            const statusDiv = document.getElementById('data-status');
            
            try {
                // Generate realistic mouse movement data
                mouseData = [];
                
                for (let i = 0; i < 200; i++) {
                    // Create some clusters of movement
                    let x, y;
                    if (i < 50) {
                        // Top-left cluster
                        x = 200 + Math.random() * 100;
                        y = 200 + Math.random() * 100;
                    } else if (i < 100) {
                        // Top-right cluster
                        x = window.innerWidth - 300 + Math.random() * 100;
                        y = 200 + Math.random() * 100;
                    } else if (i < 150) {
                        // Bottom area
                        x = window.innerWidth/2 + (Math.random() - 0.5) * 300;
                        y = window.innerHeight - 300 + Math.random() * 100;
                    } else {
                        // Random scattered points
                        x = Math.random() * window.innerWidth;
                        y = Math.random() * window.innerHeight;
                    }
                    
                    mouseData.push({
                        x: Math.round(x),
                        y: Math.round(y),
                        timestamp: Date.now() + (i * 16)
                    });
                }
                
                // Try to inject data into MouseView if available
                if (typeof mouseview !== 'undefined' && mouseview.datalogger) {
                    mouseview.datalogger.data = mouseData;
                    statusDiv.innerHTML = `<div class="status success">✅ Generated ${mouseData.length} mouse points and injected into MouseView</div>`;
                } else {
                    statusDiv.innerHTML = `<div class="status info">ℹ️ Generated ${mouseData.length} mouse points (MouseView not ready for injection)</div>`;
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ Error: ${error.message}</div>`;
                console.error('Data generation failed:', error);
            }
        }
        
        function testPlotHeatMap() {
            const statusDiv = document.getElementById('heatmap-status');
            
            try {
                if (typeof mouseview === 'undefined') {
                    throw new Error('MouseView not loaded');
                }
                
                if (typeof mouseview.plotHeatMap !== 'function') {
                    throw new Error('plotHeatMap method not available');
                }
                
                // Call plotHeatMap
                mouseview.plotHeatMap();
                
                statusDiv.innerHTML = '<div class="status success">✅ plotHeatMap() called successfully</div>';
                
                // Give it a moment to render, then inspect
                setTimeout(inspectHeatmapCanvas, 500);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ Error: ${error.message}</div>`;
                console.error('plotHeatMap failed:', error);
            }
        }
        
        function clearHeatMap() {
            const statusDiv = document.getElementById('heatmap-status');
            
            try {
                if (typeof mouseview !== 'undefined' && typeof mouseview.clearHeatMap === 'function') {
                    mouseview.clearHeatMap();
                    statusDiv.innerHTML = '<div class="status info">ℹ️ Heatmap cleared</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">❌ clearHeatMap not available</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ Error: ${error.message}</div>`;
                console.error('clearHeatMap failed:', error);
            }
        }
        
        function inspectHeatmapCanvas() {
            const statusDiv = document.getElementById('canvas-status');
            const resultsDiv = document.getElementById('investigation-results');
            
            try {
                // Look for heatmap canvas
                const heatmapCanvas = document.getElementById('heatmap');
                
                if (heatmapCanvas) {
                    const info = {
                        tagName: heatmapCanvas.tagName,
                        id: heatmapCanvas.id,
                        width: heatmapCanvas.width,
                        height: heatmapCanvas.height,
                        style: heatmapCanvas.style.cssText,
                        position: {
                            offsetTop: heatmapCanvas.offsetTop,
                            offsetLeft: heatmapCanvas.offsetLeft
                        },
                        hasContext: !!heatmapCanvas.getContext,
                        contextType: heatmapCanvas.getContext ? '2d available' : 'no context'
                    };
                    
                    statusDiv.innerHTML = '<div class="status success">✅ Heatmap canvas found!</div>';
                    resultsDiv.innerHTML = `
                        <h4>Canvas Properties:</h4>
                        <pre>${JSON.stringify(info, null, 2)}</pre>
                        <p><strong>Screenshot Capability:</strong> ✅ Yes - Canvas can be converted to image using toDataURL() or toBlob()</p>
                    `;
                    
                } else {
                    statusDiv.innerHTML = '<div class="status error">❌ No heatmap canvas found</div>';
                    
                    // Check for other canvases
                    const allCanvases = document.querySelectorAll('canvas');
                    resultsDiv.innerHTML = `
                        <h4>All Canvases Found:</h4>
                        <pre>${Array.from(allCanvases).map(c => ({id: c.id, width: c.width, height: c.height}))}</pre>
                    `;
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ Error: ${error.message}</div>`;
                console.error('Canvas inspection failed:', error);
            }
        }
        
        function screenshotHeatmap() {
            const statusDiv = document.getElementById('canvas-status');
            
            try {
                const heatmapCanvas = document.getElementById('heatmap');
                
                if (!heatmapCanvas) {
                    throw new Error('Heatmap canvas not found. Call plotHeatMap() first.');
                }
                
                // Convert canvas to blob and download
                heatmapCanvas.toBlob((blob) => {
                    if (blob) {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = 'mouseview_heatmap_screenshot.png';
                        link.click();
                        URL.revokeObjectURL(url);
                        
                        statusDiv.innerHTML = '<div class="status success">✅ Heatmap screenshot downloaded!</div>';
                    } else {
                        throw new Error('Failed to create blob from canvas');
                    }
                }, 'image/png');
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ Error: ${error.message}</div>`;
                console.error('Screenshot failed:', error);
            }
        }
        
        // Auto-initialize when MouseView loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (typeof mouseview !== 'undefined') {
                    console.log('MouseView loaded:', mouseview);
                    console.log('plotHeatMap available:', typeof mouseview.plotHeatMap);
                    console.log('clearHeatMap available:', typeof mouseview.clearHeatMap);
                } else {
                    console.log('MouseView not loaded');
                }
            }, 1000);
        });
    </script>
</body>
</html>